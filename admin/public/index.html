<!doctype html>
<head>
  <meta charset="utf-8">

  <title>GoOut! Admin</title>
  <meta name="description" content="GoOut Admin">
  <meta name="viewport" content="width=device-width">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <!--<link href="/stylesheets/print.css" media="print" rel="stylesheet" type="text/css" />-->
  <!--[if IE]>
      <link href="/stylesheets/ie.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <![endif]-->
  <script type="text/javascript" src="/prescripts.js"></script>
  <!--<script type="text/javascript" src="/js/libs/jquery.min-withPlugins.js"></script>
  <script type="text/javascript" src="/js/libs/parse.min.js"></script>
  <script type="text/javascript" src="/js/libs/underscore.min.js"></script>
  <script type="text/javascript" src="/js/libs/bootstrap.min.js"></script>-->
</head>
<body>
  <div id="fb-root"></div>
  <script>
    window.fbAsyncInit = function() {
      // init the FB JS SDK
      Parse.FacebookUtils.init({
        appId      : '420811884622087', // App ID from the App Dashboard
        channelUrl : 'http://admin.gooutdatingapp.com/channel.php', // Channel File for x-domain communication
        status     : true, // check the login status upon init?
        cookie     : true, // set sessions cookies to allow your server to access the session?
        xfbml      : true  // parse XFBML tags on this page?
      });

      // Additional initialization code such as adding Event Listeners goes here
    };

    // Load the SDK's source Asynchronously
    (function(d){
       var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
       if (d.getElementById(id)) {return;}
       js = d.createElement('script'); js.id = id; js.async = true;
       js.src = "//connect.facebook.net/en_US/all.js";
       ref.parentNode.insertBefore(js, ref);
     }(document));
  </script>

  <div id="mainContainer">
    <div id="loadingScreen">
        <img class="loaderImg" src="/img/ajax-loader.gif"/>
        <div id="loadingText"></div>
    </div>
    
    <div id="leftMenu">
    </div>
    <div id="activities"></div>
  </div>
  
  <script>
    var test;
    var hostname = window.location.hostname.split('.')[0];
    if(hostname == 'testadmin') test = true;
    // test = false; // force the panel to run live enviroment
    if(test) Parse.initialize("FuPRjFHiMoNYhDuFNSi6uTTHvZgNCj0PKM9rrRis","wWkflIj8N9VlEurowTHRnUZert4boDN2AWg40Axg");
    else Parse.initialize("LT8zCCzhUMOstx3v7MoQrB9U3lEN6elxSz7n2cPr","Bsw0ILjFiBGlsqxfu9gvUaBxSuc9Hbi9CCNYcaXJ");
    
  </script>
  <script type="text/javascript" src="/app.js"></script>
</body>

<script type="text/template" id="tplLogin">
  <div class="loginContainer">
      <h1>Authorization</h1>
      <button class="btn btn-large btn-primary" id="loginBtn">Login with facebook</button>
  </div>
</script>
<script type="text/template" id="tplChats">
    <% if(statistics) print(statistics); %>
<div id="actChats">
    <table class="table">
        <tbody>
            <% _.each(chats,function(chat){ %>
                <% var girl = chat.get('girl'); var boy = chat.get('boy'); %>
                <tr>
                    <td userId="<%= girl ? girl.id : '#' %>" class="girlImage userRow"><img src="<%= girl ? girl.get('profilePicture').url : '/img/noUser.png' %>"%></td>
                    <td userId="<%= girl ? girl.id : '#' %>" class="girlName userRow"><h5><%= girl ? girl.get('name') : '# Deleted' %></h5></td>
                    <td><h5><%= chat.get('girl_answer') %></h5></td>
                    <td><button chatId="<%= chat.id %>" class="btn chatButton">Go to chat</button></td>
                    <td><h5><%= chat.get('charged') %>p</h5></td>
                    <td><h5><%= chat.get('boy_answer') %></h5></td>
                    <td class="boyName"><h5><%= boy ? boy.get('name') : 'Deleted' %></h5></td>
                    <td class="boyImage"><img src="<%= boy ? boy.get('profilePicture').url : '/img/noUser.png' %>"%></td></tr>
            <% }); %>
        </tbody>
    </table>
</div>
</script>
<script type="text/template" id="tplChat">
<div id="actChat">
    <table class="table table-bordered users">
        <tbody>
            <tr userId="<%= girl ? girl.id : '#' %>" class="userRow">
                <td class="picture"><img src="<%= girl ? girl.get('profilePicture').url : '#' %>" /></td>
                <td class="message"><h5><%= girl ? girl.get('name') : 'Deleted' %></h5></td>
            </tr>
            <tr userId="<%= boy ? boy.id : '#' %>" class="userRow">
                <td class="picture"><img src="<%= boy ? boy.get('profilePicture').url : '#'%>"></td>
                <td class="message"><h5><%= boy ? boy.get('name') : 'Deleted' %></h5></td>
            </tr>
        </tbody>
    </table>
    <table class="table">
        <tbody>
            <% _.each(messages,function(message){ %>
                <tr>
                    <td class="picture"><img src="<%= (message.get('senderId') == girl.id) ? (girl ? girl.get('profilePicture').url : '#') : (boy ? boy.get('profilePicture').url : '#') %>" /></td>
                    <td class="message"><h5><%= message.get('message') %></h5></td>
                    <td class="time"><h5><%= timeAgo(message.createdAt) %></h5></td>
                </tr>
            <% }); %>
        </tbody>
    </table>
</div>
</script>
<script type="text/template" id="tplInvitations">

</script>
<script type="text/template" id="tplFaq">
<div id="actFaq">
    <div><button class="btn openAddFaq">Add a FAQ</button></div>
    <div id="addFaqContainer"> 
        <div><input id="faqQuestion" type="text" placeholder="Question"/></div>
        <div><textarea id="faqAnswer" rows="4" placeholder="Answer"></textarea></div>
        <div><input id="faqOrder" type="text" placeholder="Order"/></div>
        <button class="btn btn-primary addFaqBtn">OK</button>     <button class="btn btn-warning cancelButton">Cancel</button>
    </div>

    <table class="table" id="faqTable">
    
    </table>
</div>
</script>
<script type="text/template" id="tplFaqTable">
<% _.each(faqs,function(faq){ %>
    <tr>
        <td><h1><%= faq.get('order') %></h1></td>
        <td><h5><%= faq.get('question') %></h5><blockquote><p><%= faq.get('answer') %></p></blockquote></td>
        <td class="edit"><button objectId="<%= faq.id %>" class="btn editButton">Edit</button></td>
    </tr>
<% }); %>
</script>

<script type="text/template" id="tplTasks">
<div id="actTasks">
    <div><button class="btn openAddTask">Add a Task</button></div>
    <div id="addTaskContainer">
        <select class="span2" id="taskType">
            <option value="choose">Choose type</option>
            <option value="photo">Photo Task</option>
            <option value="question">Question Task</option>
        </select>
        <div><input id="taskTitle" type="text" placeholder="Title"/></div>
        <div><input id="taskOrder" style="width:40px;" type="text" placeholder="Order"/></div>
        <button class="btn btn-primary addTaskBtn">OK</button>     <button class="btn btn-warning cancelButton">Cancel</button>
        
    </div>

    <table class="table" id="taskTable">
    </table>
</div>
</script>
<script type="text/template" id="tplTaskTable">

<% _.each(groups,function(tasks,name){ %>
    <thead>
        <tr><th><h3><%= name %></h3></th><th></th></tr>
    </thead>
    <tbody>
    <% _.each(tasks,function(task){ %>
        <tr class="<%= task.get('standard') ? 'success' : (task.get('deployed') ? 'error' : 'warning') %>">
            <td class="order"><h4><%= task.get('order') ? task.get('order') : '' %></h4></td>
            <td><%= task.get('title') %></td>
            <td>
                <button objectId="<%= task.id %>" class="btn <%= task.get('standard') ? 'btn-danger' : 'btn-success' %> acdetivateButton"><%= task.get('standard') ? 'Deactivate' : 'Activate' %></button>
            </td>
            <td class="edit">
                <button objectId="<%= task.id %>" class="btn editButton">Edit</button>
            </td>
        </tr>
    <% }); %>
    </tbody>
<% }); %>

</script>


<script type="text/template" id="tplMenu">
    <div class="well">
        <ul class="nav nav-list">
            <li class="nav-header">Menu</li>
            <li><a href="games">Games</a></li>
            <li><a href="users">Users</a></li>
            
            <li><a href="chats">Chats</a></li>
            <li><a href="statistics">Statistics</a></li>
            <li class="divider"></li>
            <li><a href="reported">Reported answers</a></li>
            <li><a href="answers">All answers</a></li>
            <li><a href="invitations">Invitations</a></li>
            <li><a href="tasks">Tasks</a></li>
            <li><a href="faq">FAQ</a></li>
            <li class="divider"></li>

            <li><a href="logout">Log out</a></li>
        </ul>
    </div>
</script>
<script type="text/template" id="tplStatistics">
<div id="actStatistics">
    <table class="table">
        <thead>
            <tr><th>Time span 1</th><th>Time span 2</th></tr>
        </thead>
        <tbody>
            <tr><td>From: <input type="text" id="pick1-from" class="datepicker" /></td><td>From: <input type="text" id="pick2-from" class="datepicker" /></td></tr>
            <tr><td>To: <input type="text" id="pick1-to" class="datepicker" /></td><td>To: <input type="text" id="pick2-to" class="datepicker" /></td></tr>
        </tbody>
    </table>
    <a id="loadStatButton" class="btn btn-primary">Load Statistics</a>
    <div id="statisticResults"></div>
</div>
</script>
<script type="text/template" id="tplStatisticResults">
    <table class="table">
        <thead>
            <tr><th>Goal</th><th>Span 1</th><th>Span 2</th><th>Varians</th></tr>
        </thead>
        <tbody>
        <% for(var statKey in structure){ 
            var num1 = pick1Result[statKey];
            var num2 = pick2Result[statKey];
            %> 
            <tr>
                <td><strong><%= structure[statKey] %></strong></td>
                <td><% if(num1) print(num1); else print(0); %></td>
                <td><% if(num2) print(num2); else print(0); %></td>
                <td><%
                    var varians = (num2-num1)/num1*100;
                    print(varians+"%"); %></td>
            </tr>
        <% } %>
        </tbody>
    </table>
</script>
<script type="text/template" id="tplUsers">
<% if(statistics) print(statistics); %>
<div id="actUsers">
    <table class="table">
    <% _.each(users,function(user){ %>
        <tr class="userRow <%= user.get('blocked') ? 'error' : '' %>" userId="<%= user.id %>">
            <td class="profile"><img  class="polaroid" src="<%= user.get('profilePicture') ? user.get('profilePicture').url : '/img/noUser.png'%>"/></td>
            <td class="name"><h5><%= user.get('name') %></h5></td>
            <td class="age"><h5><%= getAge(user.get('birthday')) %></h5></td>
            <td class="place"><h5><%= user.get('place') %></h5></td>
            
            <td class="timeAgo"><h5><%= readableDate(user.createdAt) %></h5></td>
            <td class="gender"><h5><% if(user.get('gender') == 'male') print('M'); %><% if(user.get('gender') == 'female') print('F'); %></h5></td>
            <td class="points"><h5><%= user.get('points') %>p</h5></td>
        </tr>
    <% }); %>
    </table>
</div>
</script>
<script type="text/template" id="tplUser">
<div id="actUser">
<h3>
    <img style="height:100px" class="polaroid" src="<%= user.get('profilePicture') ? user.get('profilePicture').url : '/img/noUser.png'%>"/>
    &nbsp;&nbsp;&nbsp;&nbsp;<%= user.get('name') %>
    <a target="_blank" href="http://facebook.com/<%= user.get('facebookId') %>"><img src="/stylesheets/images/facebook_button.png"/></a>
</h3>

<% if(statistics) print(statistics); %>

<form id="addCoins">
    <fieldset>
        <legend>Adjust coins</legend>
        <input type="text" class="coins" placeholder="Amount"> Current: <span id="currentCoins"><%= user.get('points') %></span>
        <label>Send push notification?</label>
        <input id="sendPushCheck" type="checkbox"> Push <input type="text" class="pushMessage" placeholder="Message"><br/>
        <button class="btn btn-primary adjustCoinsButton">Update</button>
    </fieldset>
</form>

</div>
</script>
<script type="text/template" id="tplStatNumbers">
    <table class="table table-striped statTable">
        <tbody>
        <% _.each(statistics,function(info,title){ %>
            <tr><td><%= title %></td><td><%= info %></td></tr>
        <% }); %>
        </tbody>
    </table>
</script>
<script type="text/template" id="tplGames">
<% if(statistics) print(statistics); %>
<div id="actGames">

  <table class="table">
        <tbody> 
        <% _.each(gamesContainer, function(container,gameId) { %>
            <tr>
                <td class="userRow" userId="<%=container.game.get('girl').id %>"><img src="<%= container.game.get('girl').get('profilePicture').url %>"/></td>
                <td><h5><%= container.game.get('girl').get('name') %></h5></td>
                <td><button class="btn gameButton" gameId="<%= container.game.get('gameId')%>">Go to game</button>
                <td class="boys">

                    <table class="table">
                        <tbody>
                        <% _.each(container.gamePlayers, function(gamePlayer){ %>
                            <tr  userId="<%= gamePlayer.get('user') ? gamePlayer.get('user').id : false %>" class="userRow <% if(gamePlayer.get('isWinner')) print('success') %> <% if(gamePlayer.get('isEliminated')) print('error') %>">
                                
                                <td>
                                    <img class="userImage boyImage" src="<%= gamePlayer.get('user') ? gamePlayer.get('user').get('profilePicture').url : false %>"/>
                                    <%= gamePlayer.get('user') ? gamePlayer.get('user').get('name') : false %>
                                </td>
                            </tr>
                        <% }); %>
                        
                        </tbody>
                    </table>
                </td>
            </tr>
        <% }); %>
        </tbody>
    </table>
</div>
</script>
<script type="text/template" id="tplGame">
<% if(statistics) print(statistics); %>

<div id="actGame">
    <table class="table">
        <thead>
            <tr>
                <th>Player</th>
                <th>Joined at</th>
                <th>Eliminated at task #</th>
            </tr>
        </thead>
    <% var place = 0; var tempEliminatedAt = 0; %>
        <% var girl = gameContainer.girl; %>
        <tr class="userRow" userId="<%= girl.id %>">
            
            <td ><img src="<%= girl ? girl.get('profilePicture').url : '/img/noUser.png' %>"/>  <%= girl ? girl.get('name') : 'Deleted' %></td>
            <td><%= readableDate(gameContainer.game.createdAt) %></td>
            
            <td>Girl</td>
        </tr>
    <% var maxPlayers = parseInt(gameContainer.game.get('maxPlayers'),10); var latestJoinDate;
        var winnerFound;
    %>
    <% _.each(_.sortBy(gameContainer.gamePlayers,function(gamePlayer){ return -gamePlayer.get('eliminatedAt')}),function(gamePlayer,num){
            if(!latestJoinDate || (latestJoinDate && gamePlayer.createdAt.getTime() > latestJoinDate.getTime())) latestJoinDate = gamePlayer.createdAt;
            var user = gamePlayer.get('user'); 
        %>
        <tr class="userRow" userId="<%= gamePlayer.id %>">
            <td ><img src="<%= user ? user.get('profilePicture').url : '/img/noUser.png' %>"/>  <%= user ? user.get('name') : 'Deleted' %></td>
            <td><% 
                if(gamePlayer.createdAt.getTime() < gameContainer.game.createdAt.getTime()) print("Added. Waiting since: <br/>");
                print(readableDate(gamePlayer.createdAt)); %> 
            </td>
            <td>
            
            <% if(gamePlayer.get('isEliminated')){
                print(parseInt(gamePlayer.get('eliminatedAt'),10));

            }
            else if(gamePlayer.get('isWinner')){
                print('Winner');
                winnerFound = true;
            } 
            else print('Playing');%>
            </td>
        </tr>
    <% }); %>
    </table>
    <h5><% if(maxPlayers == gameContainer.playerCounter) print("Game started: "+readableDate(latestJoinDate)); 
        else print('Waiting for players to join');
    %></h5>
    <% var taskCounter = 0; %>

    <% _.each(gameContainer.gameTasks, function(gameTask,gameTaskId) { taskCounter++; %>
    <% var eliminatedByTime = gameTask.get('eliminatedByTime') ? gameTask.get('eliminatedByTime').split(",") : []; %>
    <h4><%= gameTask.get('taskNumber') %>: <%= gameTask.get('task').get('title') %></h4>
    <h5><%= readableDate(gameTask.createdAt) %></h5>
    <div class="row-fluid answerRowContainer" >
        <ul class="thumbnails">
            <% var answerCounter = 0; var expectedAnswerCount = parseInt(gameTask.get('expectedAnswerCount'),10); %>
             <% _.each(gameContainer.answers[gameTaskId],function(answer,answerId) { answerCounter++; %>
                <% var gamePlayer = gameContainer.gamePlayers[answer.get('gamePlayerId')]; var user = gamePlayer ? gamePlayer.get('user') : false; %>
                <li class="span3">
                    <div class="thumbnail" gameId="<%= answer.get('gameId') %>" objectId="<%= answer.id %>">
                    <% if(answer.get('fileAnswer')){ %>
                            <img class="image" src="<%= answer.get('fileAnswer')['url'] %>" alt="">
                    <% } else { %>
                            <div class="text"><%= answer.get('textAnswer')%></div>
                    <% } %>
                        <div class="answerStatus">
                            <img src="<%= user ? user.get('profilePicture').url : '/img/noUser.png' %>"/>
                            <%= readableDate(answer.createdAt) %>
                            <% 
                                if(gameTask.get('eliminatedPlayerId') == answer.get('gamePlayerId')) print('Eliminated by girl');
                            %>

                        </div>
                    </div>

                </li>
                
            <% }); %>
            <% var missingAnswerCount = expectedAnswerCount - answerCounter; 
                if(missingAnswerCount > 0){
                    for(var j = 0 ; j < missingAnswerCount ; j++){ %>
                    <li class="span3">
                        <div class="thumbnail">
                            <b><%= (eliminatedByTime.length > 0) ? "Eliminated by time" : "Waiting for answer" %></b>
                        </div>

                    </li>
                <%  }
                } %>
        </ul>
    </div>
    <h4>
    </h4>
    <h5>
    <% if(taskCounter == gameContainer.taskCounter){
        var hasEliminated = gameTask.get('eliminatedPlayerId') ? true : false;
        if(gameContainer.game.get('closed')) print('Game is closed');
        else if(winnerFound) print('Winner was found');
        else if(missingAnswerCount == 0){
            if(!hasEliminated) print('Waiting for girl to eliminate');
            else print('task is done');
        }
        else {
            if(eliminatedByTime.length == 0) print('Waiting for answers');
            else{
                if(!hasEliminated) print('Waiting for girl to eliminate');
                else print("task is done");
            }
        }
    }%></h5>
    <% }); %>
</div>
</script>
<script type="text/template" id="tplAnswers">
<div id="actAnswers" class="<%= reported ? 'reported' : 'answers' %>">
    <ul class="thumbnails">

        <% _.each(answers, function(answer) { %> 
            <li class="span3">
                <div href="#" class="thumbnail" objectId="<%= answer.id %>">
                <% if(answer.get('fileAnswer')){ %>
                        <img class="image" src="<%= answer.get('fileAnswer')['url'] %>" alt="">
                <% } else { %>
                        <div class="text"><%= answer.get('textAnswer')%></div>
                <% } 
                %>
                    <div class="<%= answer.get('blocked') ? 'blocked' : '' %>"> 
                        <button gameId="<%= answer.get('gameId') %>" class="btn gameButton">Game</button>
                        <button answerId="<%= answer.id %>" class="btn <%= answer.get('blocked') ? 'btn-warning' : 'btn-danger' %> blockButton"><%= answer.get('blocked') ? 'Unblock' : 'Block' %></button>    
                    </div>
                </div>
            </li>
        <% }); %>
    </ul>      
</div>
    
</script>
<script type="text/template" id="tplImageAnswer">
</script>

<script type="text/template" id="tplDashboard">
</script>