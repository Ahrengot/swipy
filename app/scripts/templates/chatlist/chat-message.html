<% 
	var hasProfilePicture = "";
	var user = data.message.get("user");
	var sender;
	/*if(data.message.get("file"))
		console.log(data.message.toJSON());*/
	var profilePictureURL;
	if(user){
		sender = swipy.slackCollections.users.get(user);
		profilePictureURL = sender.get("profile").image_192;
	}
	var bot_id = data.message.get("bot_id");
	if(bot_id){
		sender = swipy.slackCollections.bots.get(bot_id);
		profilePictureURL = sender.get("icons").image_48;
	}
	if(data.message.get("comment")){
		sender = swipy.slackCollections.users.get(data.message.get("comment").user)
		profilePictureURL = sender.get("profile").image_192;
	}
	
	var icons = data.message.get("icons");
	
	var name = "";

	if(sender){
		name = sender.get("name");
	}


	var username = data.message.get("username");
	if(username && !name){
		name = username;
	}
	if(!name)
		console.log(data.message);
	if(icons && !profilePictureURL){
		profilePictureURL = icons.image_48;
	}

	var hasAttachment = false;
	var numberOfLikes = data.message.get("numberOfLikes");
	var shouldShowBigLike = false;
	if( data.message.get("attachments") ){
		hasAttachment = true;
		shouldShowBigLike = true;
	}
	if(numberOfLikes > 0){
		shouldShowBigLike = true;
	}
	var isLikedClass = ""
	if(data.message.get("likedByMe"))
		isLikedClass = "liked"

	var likeString = "Be the first to like this.";
	if(numberOfLikes > 0){
		if(data.message.get("likedByMe")){
			if(numberOfLikes == 1){
				likeString = "You like this.";
			}
			else{
				var numberLeft = numberOfLikes - 1;
				likeString = "You and " + numberLeft + " others like this."
			}
		}
		else{
			if(numberOfLikes == 1){
				likeString = "1 person like this."
			}
			else
				likeString = numberOfLikes + " people like this."
		}
	}
	function handleMentionsAndLinks(text){
		if(!text)
			return;
		var matches = text.match(/<(.*?)>/g);
		if(matches && matches.length > 0){
			for(var i = 0 ; i < matches.length ; i++){
				match = matches[i];
				var replacement = "";
				// remove the <>
				match = match.substring(1, match.length-1);
				var res = match.split("|");
				var action = res[0];
				var placeholder = action;
				if(res && res.length > 1)
					placeholder = res[1];

				// URL handling
				if(action.startsWith("http") || action.startsWith("mailto:")){
					var targetPart = "target=\"_blank\"";
					if(action.startsWith("http://swipesapp.com/task/")){
						action = "#" + action.substring("http://swipesapp.com/".length);
						targetPart = "class=\"catchClick\"";
					}
					if(action.startsWith("mailto:"))
						targetPart = "";
					replacement = "<a " + targetPart + " href=\""+action+"\">" + placeholder + "</a>";
				}
				else if( action.startsWith("@U")){
					var user = swipy.slackCollections.users.get(action.substring(1))
					if(user){
						placeholder = user.get("name")
						replacement = "<a href=\"#im/"+placeholder+"\">@"+placeholder + "</a>";
					}
				}
				else if( action.startsWith("@C")){
					placeholder = swipy.slackCollections.channels.get(action.substring(1)).get("name")
					replacement = "<a href=\"#channel/"+placeholder+"\">@"+placeholder + "</a>";
				} 
				else{
					console.log(match);
				}
				text = text.replace("<" + match+ ">", replacement);

			}
			
		};
		text = text.replace(/(?:\r\n|\r|\n)/g, '<br>')
		return text;
	};
	var hasImageClass = "hasProfileImage";
	if(data.isFromSameSender)
		hasImageClass = "";
%>
<div class="chat-message <%= hasImageClass %>">
	<div class="chat-left-side-container">
		<% if(!data.isFromSameSender){ %>
		<div class="picture-container">
			<div class="picture-circular" style="background: url(<%= profilePictureURL %>) no-repeat; background-size: 34px 34px;">
			</div>
		</div>
		<% } else { %>
			<div class="left-hover-box">
				<% if(!shouldShowBigLike){ %>
				<!--<a class="like-button">
					<svg class="icon">
						<use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-thumb"></use>
					</svg>
				</a>-->
				<% } %>
				<span class="timestamp"><%= data.message.get("timeStr") %></span>
			</div>
		<% } %>
	</div>
	<div class="chat-right-side-container">
		<% if(!data.isFromSameSender){ %>
		<div class="sender-container">
			<span class="sender-name"><%= name %></span>
			<span class="timestamp"><%= data.message.get("timeStr") %></span>
			<% if(!shouldShowBigLike){ %> 
			<span class="top-hover-box">
				<!--<a class="like-button">
					<svg class="icon">
						<use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-thumb"></use>
					</svg>
				</a>-->
			</span>
			<% } %>
		</div>
		<% } %>
		<div class="message-container">
			<%= handleMentionsAndLinks(data.message.get("text")) %>
		</div>
		<% if(data.message.get("subtype") == "file_share") { %>
			<div class="file-container">
				<div class="comment"></div>
				<% var file = data.message.get("file");
				if(file.thumb_360){ %>
					<img style="height: <%= file.thumb_360_h %>px; width:<%= file.thumb_360_w %>px;" src="<%= file.thumb_360 %>" />
				<% } %>
			</div>
		<% } %>
		<% if( hasAttachment ){ %>
		
			<%= data.attTmpl({attachments: data.message.get("attachments"), handleMentionsAndLinks: handleMentionsAndLinks}) %>
			<!--<a href="http://test.com" target="_blank"><img src="styles/img/temp/attachment-placeholder.png"></a>-->

		
		<% } %>
		<% if(shouldShowBigLike){ %>
		<!--<div class="like-container">
			<a class="like-button <%= isLikedClass %>">
				<svg class="icon">
					<use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-thumb"></use>
				</svg>
			</a>
			<span class="like-string">
				<%= likeString %>
			</span>
		</div>-->
		<% } %>
	</div>
</div>