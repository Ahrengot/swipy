<% 

	var hasMetaClass = "";
	var sourceOfTask, timeString, numberOfTags;
	if(data.showSource){
		var currentUserId = Parse.User.current().id
		if(data.task.get("projectLocalId")){
			var srcProj = swipy.collections.projects.get(data.task.get("projectLocalId"));
			if(srcProj)
				sourceOfTask = srcProj.get("name");
		}
		else if(data.task.get("toUserId") === currentUserId && data.task.get("userId") !== currentUserId){
			var srcMember = swipy.collections.members.get(data.task.get("userId"));
			if(srcMember)
				sourceOfTask = srcMember.get("username");
		}
		else{
			sourceOfTask = "Personal";
		}
	}
	var numberOfMetaInfos = 0;
	if (sourceOfTask)
		numberOfMetaInfos++;

	if( data.showSchedule && data.task.get("timeStr") ){
		timeString = data.task.get("timeStr")
		numberOfMetaInfos++;
	}

	if (data.task.get('tags') && data.task.get('tags').length){
		numberOfMetaInfos++;
		numberOfTags = data.task.get('tags').length;
	}

	var numberOfAssignees = 0;
	if (data.task.get("assignees") && data.task.get("assignees").length ){
		numberOfAssignees = data.task.get("assignees").length
		numberOfMetaInfos++;
	}
	if (numberOfMetaInfos > 0)
		hasMetaClass = "has-meta";
	

	var assignedClass = "";
	if(data.task.get("isAssigned"))
		assignedClass = "assigned";
	if(data.task.get("isMyTask"))
		assignedClass = "my-task";
	if(data.task.get("completionDate"))
		assignedClass = "completed";
%>
<div class="card-container <%= hasMetaClass %> <%= assignedClass %>">
	<div class="main-info-container">
		<h2 class="title"><span class="priority"></span><%= data.task.get('title') %></h2>
		
		<!--<span class="progress-label">50%</span>-->
		
		<% if (numberOfMetaInfos > 0) { %>
			<div class="meta">
			<% if (timeString) { %>
				<div class="meta-text"><%= timeString %></div>

			<% } if (sourceOfTask) { %>
				<div class="meta-text"><%= sourceOfTask %></div>

			<% } if(numberOfAssignees) { %>
				<div class="meta-text with-icon" title="This task has been assigned to 3 people">
					<svg class="icon"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-taskIconAssigned"></use></svg><%= numberOfAssignees %>
				</div>
			<% } if (numberOfTags) { %>
					
					<div class="meta-text tags">
						<%
						tagStrings = _.invoke(data.task.get('tags'), "get", "title")
						tags = _.sortBy( data.task.get('tags'), function(tag) {
							return tag.get("title").toLowerCase()
						})

						_.each(data.task.get('tags'), function(tag, i) {
							isInFilter = _.contains(swipy.filter.tagsFilter, tag.get("title") )
							
							if ( isInFilter ) { %><strong> <% } %>
								
								<a href="#" data-href="<%= tag.id %>" class="clickable-tag"><%= tag.get("title") %></a><% if ( i+1 < numberOfTags ) print(",&nbsp;"); %>
							
							<% if ( isInFilter ) { %></strong> <% }
							 
								
						}); %>
					</div><!-- .meta-text .tags -->				
			<% } %>
			</div><!-- .meta -->
		<% } %>
	</div>
	<div class="actions">
		<div>
		<% if(data.task.get("projectLocalId")) { %>
			<a href="#" class="assign-button" title="Assign people to this task">
				<svg class="icon"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-quickBarAssign"></use></svg>
			</a>
		<% } %>
		<% state = data.task.get("state") %>
			<a href="#" class="schedule-button" title="Schedule todo">
				<svg class="icon">
					<use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-quickBarSnooze"></use>
				</svg>
			</a>
		<% if (state !== "completed"){ %>
			<a href="#" class="complete-button" title="Mark task as completed">
				<svg class="icon">
					<use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-quickBarComplete"></use>
				</svg>
			</a>
		<% } %>

		<!--<a href="JavaScript:void(0);" class="more-button" title="Start workmode with this task">
			<svg class="icon"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-navbarWorkspace"></use></svg>
		</a>-->
		</div>
	</div>
	<div class="expanding">
		<img src="styles/img/editmode-preview.png">
	</div>
</div><!-- .card-container -->
<% numberOfButtons = 2 
	if(data.task.get("projectLocalId"))
		numberOfButtons++;
%>
